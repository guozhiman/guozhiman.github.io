<?php defined('IN_XQCMS') or exit('Access Denied');class onepage {public $id;public $cid;private $db;private $table;public function onepage() {global $db, $XQ_PRE;$this->table = $XQ_PRE.'onepage';$this->db = &$db;}private function public_check($post) {global $MOD, $XQ_TIME, $L;if(!is_array($post)) msg();if(!$post['title']) msg($L['onepage_pass_title']);if(isset($post['islink'])) {if(!$post['url']) msg($L['onepage_pass_linkurl']);} else {if($post['filepath'] && !preg_match("/^[0-9a-z_\-\/]+\/$/", $post['filepath'])) msg($L['onepage_pass_path']);if($post['filename'] && !preg_match("/^[0-9a-z_\-]+\.[a-z]+$/", $post['filename'])) msg($L['onepage_pass_name']);if($post['filename']) {if($this->id) {$r = $this->fone();if($r['url'] != $post['filepath'].$post['filename']) {if(is_file(XQ_ROOT.'/'.$post['filepath'].$post['filename'])) msg($L['onepage_pass_exist']);}} else {if(is_file(XQ_ROOT.'/'.$post['filepath'].$post['filename'])) msg($L['onepage_pass_exist']);}}}$post['islink'] = isset($post['islink']) ? 1 : 0;if(!$post['islink']) {if($post['filename']) {$post['url'] = $post['filepath'].$post['filename'];} else {$post['url'] = $post['filepath'].$this->id.'.'.$XQ['file_ext'];}}$post['edittime'] = $XQ_TIME;if($post['content'] && isset($post['clear_link'])) $post['content'] = clear_link($post['content']);if($post['content'] && isset($post['save_remotepic'])) $post['content'] = save_remote(stripslashes($post['content']));$post['cid'] = $this->cid;unset($post['filepath']);unset($post['filename']);unset($post['clear_link']);unset($post['save_remotepic']);return $post;}public function fone() {return $this->db->get_one("SELECT * FROM {$this->table} WHERE id=$this->id");}public function flist($condition = 'status=3', $order = 'listorder DESC, id DESC') {global $MOD, $pages, $page, $pagesize, $offset;$r = $this->db->get_one("SELECT COUNT(*) AS num FROM {$this->table} WHERE $condition");$pages = pages($r['num'], $page, $pagesize);$lists = array();$result = $this->db->query("SELECT * FROM {$this->table} WHERE $condition ORDER BY $order LIMIT $offset,$pagesize");while($r = $this->db->fetch_array($result)) {$r['title'] = set_style($r['title'], $r['color']);$r['editdate'] = timetodate($r['edittime'], 5);$r['url'] = linkurl($r['url'], 1);$lists[] = $r;}return $lists;}public function add($post) {global $XQ, $module;$post = $this->public_check($post);$sqln = $sqlv = '';foreach($post as $n=>$v) {$sqln .= ','.$n; $sqlv .= ",'$v'";}$sqln = substr($sqln, 1);$sqlv = substr($sqlv, 1);$this->db->query("INSERT INTO {$this->table} ($sqln) VALUES ($sqlv)");$this->id = $this->db->insert_id();tohtml('onepage', $module, "id=$this->id");return $this->id;}public function edit($post) {global $XQ, $module;$this->delete($this->id, false);$post = $this->public_check($post);$sql = '';foreach($post as $n=>$v) {$sql .= ",$n='$v'";}$sql = substr($sql, 1);$this->db->query("UPDATE {$this->table} SET $sql WHERE id=$this->id");tohtml('onepage', $module, "id=$this->id");return true;}function delete($id, $all = true) {if(is_array($id)) {foreach($id as $v) {$this->delete($v, $all);}} else {$this->id = $id;$r = $this->fone();if(!$r) msg('');if(!$r['islink']) {$_file = XQ_ROOT.'/'.$r['url'];if(is_file($_file)) unlink($_file);}if($all) $this->db->query("DELETE FROM {$this->table} WHERE id=$id");}}public function order($listorder) {if(!is_array($listorder)) return false;foreach($listorder as $k=>$v) {$k = intval($k);$v = intval($v);$this->db->query("UPDATE {$this->table} SET listorder=$v WHERE id=$k");}return true;}public function html() {global $module;$result = $this->db->query("SELECT * FROM {$this->table} WHERE islink=0");while($r = $this->db->fetch_array($result)) {$id = $r['id'];tohtml('onepage', $module, "id=$id");}return true;}}?>
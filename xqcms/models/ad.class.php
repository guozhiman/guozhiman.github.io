<?php defined('IN_XQCMS') or exit('Access Denied');class ad {public $aid;public $pid;private $db;private $table;private $table_pos;public function ad() {global $db;$this->db = &$db;$this->table = $this->db->pre.'ad';$this->table_pos = $this->db->pre.'ad_position';}public function adpos_add($place) {$place = $this->public_check($place);$sqln = $sqlv = '';foreach($place as $n=>$v) {$sqln .= ','.$n; $sqlv .= ",'$v'";}$sqln = substr($sqln, 1);$sqlv = substr($sqlv, 1);$this->db->query("INSERT INTO {$this->table_pos} ($sqln) VALUES ($sqlv)");$this->pid = $this->db->insert_id();return $this->pid;}public function adpos_edit($place) {$place = $this->public_check($place);$sql = '';foreach($place as $k=>$v) {$sql .= ",$k='$v'";}$sql = substr($sql, 1);$this->db->query("UPDATE {$this->table_pos} SET $sql WHERE pid=$this->pid");return true;}private function public_check($place) {global $XQ_TIME, $_username ,$L;if(!is_array($place)) msg();if(!$place['name']) msg($L['pass_ad_name']);if($place['typeid'] == 3 || $place['typeid'] == 4 || $place['typeid'] == 5) {if(!$place['width']) msg($L['pass_place_width']);if(!$place['height']) msg($L['pass_place_height']);}if($this->pid){$place['edittime'] = $XQ_TIME;}else{$place['addtime']=$place['edittime'] = $XQ_TIME;}$place['width'] = intval($place['width']);$place['height'] = intval($place['height']);return $place;}public function fone_adpos() {return $this->db->get_one("SELECT * FROM {$this->table_pos} WHERE pid='$this->pid'");}public function flist_adpos($condition = '1', $order = 'pid DESC') {global $MOD, $TYPE, $pages, $page, $pagesize, $offset, $XQ_TIME;$r = $this->db->get_one("SELECT COUNT(*) AS num FROM {$this->table_pos} WHERE $condition");$pages = pages($r['num'], $page, $pagesize);$ads = array();$result = $this->db->query("SELECT * FROM {$this->table_pos} WHERE $condition ORDER BY $order LIMIT $offset,$pagesize");while($r = $this->db->fetch_array($result)) {$r['name'] = set_style($r['name'], $r['style']);$r['adddate'] = timetodate($r['addtime'], 5);$r['editdate'] = timetodate($r['edittime'], 5);$r['width'] or $r['width'] = '--';$r['height'] or $r['height'] = '--';$r['typename'] = $TYPE[$r['typeid']];$ads[] = $r;}return $ads;}public function fadpos() {$ads = array();$result = $this->db->query("SELECT * FROM {$this->table_pos} ORDER BY pid DESC");while($r = $this->db->fetch_array($result)) {$ads[$r['pid']] = $r;}return $ads;}public function adpos_del($pid) {if(is_array($pid)) {die('jj');foreach($pid as $v) {$this->adpos_del($v);}} else {$this->db->query("DELETE FROM {$this->table_pos} WHERE pid=$pid");file_del(XQ_CACHE.'/ad/ad_'.$pid.'.htm');$result = $this->db->query("SELECT aid FROM {$this->table} WHERE pid=$pid ORDER BY aid DESC");while($r = $this->db->fetch_array($result)) {$this->delete($r['aid']);}}}private function check_ad($ad) {global $XQ_TIME, $L;if(!is_array($ad)) msg();if(!$ad['title']) msg($L['pass_ad_title']);if($ad['typeid'] == 1) {if(!$ad['code']) msg($L['pass_ad_code']);} else if($ad['typeid'] == 2) {if(!$ad['text_name']) msg($L['pass_ad_text_name']);if(!$ad['text_url']) msg($L['pass_ad_text_url']);} else if($ad['typeid'] == 3) {if(!$ad['image_src']) msg($L['pass_ad_image_src']);} else if($ad['typeid'] == 4) {if(!$ad['flash_src']) msg($L['pass_ad_flash_src']);}if($this->aid){$ad['edittime'] = $XQ_TIME;}else{$ad['addtime'] =$ad['edittime'] = $XQ_TIME;}$ad['url'] = '';if($ad['typeid'] == 2) {$ad['url'] = $ad['text_url'];} else if($ad['typeid'] == 3 || $ad['typeid'] == 5) {$ad['url'] = $ad['image_url'];} else if($ad['typeid'] == 4) {$ad['url'] = $ad['flash_url'];}return $ad;}public function fone() {return $this->db->get_one("SELECT * FROM {$this->table} WHERE aid='$this->aid'");}public function list_ad($condition = '1', $order = 'addtime DESC') {global $MOD, $TYPE, $pages, $page, $pagesize, $offset, $XQ_TIME, $L;$r = $this->db->get_one("SELECT COUNT(*) AS num FROM {$this->table} WHERE $condition");$pages = pages($r['num'], $page, $pagesize);$ads = array();$result = $this->db->query("SELECT * FROM {$this->table} WHERE $condition ORDER BY $order LIMIT $offset,$pagesize");while($r = $this->db->fetch_array($result)) {$r['adddate'] = timetodate($r['addtime'], 5);$r['editdate'] = timetodate($r['edittime'], 5);$ads[] = $r;}return $ads;}public function add($ad) {$ad = $this->check_ad($ad);$sqln = $sqlv = '';foreach($ad as $n=>$v) {$sqln .= ','.$n; $sqlv .= ",'$v'";}$sqln = substr($sqln, 1);$sqlv = substr($sqlv, 1);$this->db->query("INSERT INTO {$this->table} ($sqln) VALUES ($sqlv)");$this->aid = $this->db->insert_id();$this->db->query("UPDATE {$this->table_pos} SET ads=ads+1 WHERE pid='$ad[pid]'");return $this->aid;}public function edit($ad) {$ad = $this->check_ad($ad);$sql = '';foreach($ad as $n=>$v) {$sql .= ",$n='$v'";}$sql = substr($sql, 1);$this->db->query("UPDATE {$this->table} SET $sql WHERE aid=$this->aid");return true;}public function delete($aid) {if(is_array($aid)) {foreach($aid as $v) {$this->delete($v);}} else {$this->aid = $aid;$r = $this->fone();if(!$r) msg('');$filename = 'ad_'.$r['pid'].'.htm';file_del(XQ_CACHE.'/ad/'.$filename);$this->db->query("DELETE FROM {$this->table} WHERE aid=$aid");$this->db->query("UPDATE {$this->table_pos} SET ads=ads-1 WHERE pid='$r[pid]'");}}public function order_ad($listorder) {if(!is_array($listorder)) return false;foreach($listorder as $k=>$v) {$k = intval($k);$v = intval($v);$this->db->query("UPDATE {$this->table} SET listorder=$v WHERE aid=$k");}return true;}}?>
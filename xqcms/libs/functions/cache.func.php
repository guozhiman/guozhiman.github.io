<?php defined('IN_XQCMS') or exit('Access Denied');function cache_all() {cache_module();cache_category();cache_type();return true;}function cache_module($moduleid = 0) {global $db;if($moduleid) {$r = $db->get_one("SELECT * FROM {$db->pre}module WHERE disabled=0 AND moduleid='$moduleid'");$setting = array();$setting = get_setting($moduleid);if(isset($setting['seo_title_index'])) $setting['seo_index'] = seo_title($setting['seo_title_index']);if(isset($setting['seo_title_list'])) $setting['seo_list'] = seo_title($setting['seo_title_list']);if(isset($setting['seo_title_show'])) $setting['seo_show'] = seo_title($setting['seo_title_show']);$setting['moduleid'] = $moduleid;$setting['name'] = $r['name'];$setting['menuname'] = $r['menuname'];$setting['moduledir'] = $r['moduledir'];$setting['module'] = $r['module'];$setting['ismenu'] = $r['ismenu'];$setting['url'] = $r['url'];cache_write('module-'.$moduleid.'.php', $setting);return true;} else {$result = $db->query("SELECT moduleid,module,name,menuname,moduledir,url,color,listorder,islink,ismenu,isblank FROM {$db->pre}module WHERE disabled=0 ORDER by listorder asc,moduleid desc");$CACHE = array();$modules = array();while($r = $db->fetch_array($result)) {if(!$r['islink']) {$url = linkurl($r['moduledir'].'/');if($r['moduleid'] == 1) $url = XQ_URL;if($url != $r['url']) {$r['url'] = $url;$db->query("UPDATE {$db->pre}module set url='$url' WHERE moduleid='$r[moduleid]' ");}cache_module($r['moduleid']);}$modules[$r['moduleid']] = $r;}$CACHE['module'] = $modules;$CACHE['xq'] = cache_read('module-1.php');cache_write('module.php', $CACHE);}}function cache_category($moduleid = 0, $data = array()) {global $db, $XQ, $MODULE;if($moduleid) {if(!$data) {$result = $db->query("SELECT * FROM {$db->pre}category WHERE moduleid='$moduleid' ORDER BY listorder,catid");while($r = $db->fetch_array($result)) {$data[$r['catid']] = $r;}}$mod = cache_read('module-'.$moduleid.'.php');$a = $b = $c = array();$d = array('template', 'show_template', 'seo_title', 'seo_keywords', 'seo_description');foreach($data as $r) {$e = $r['catid'];$c[$e] = $r['items'];unset($r['items']);foreach($d as $_d) {$b[$e][$_d] = $r[$_d];unset($r[$_d]);}unset($r['moduleid']);$a[$e] = $r;};cache_write('category-'.$moduleid.'.php', $a);cache_write('catedata-'.$moduleid.'.php', $b);cache_write('cateitem-'.$moduleid.'.php', $c);if(count($data) < 100) {$categorys = array();foreach($data as $id=>$cat) {$categorys[$id] = array('id'=>$id, 'parentid'=>$cat['parentid'], 'name'=>$cat['catname']);}require_once XQ_SYSROOT.'/libs/classes/tree.class.php';$tree = new tree;$tree->tree($categorys);$content = $tree->get_tree(0, "<option value=\\\"\$id\\\">\$spacer\$name</option>").'</select>';cache_write('catetree-'.$moduleid.'.php', $content);} else {cache_delete('catetree-'.$moduleid.'.php');}} else {foreach($MODULE as $moduleid=>$module) {if($moduleid>3) cache_category($moduleid);}}}function cache_type($item = '') {global $db;if($item) {$types = array();$result = $db->query("SELECT tid,name,color FROM {$db->pre}type WHERE item='$item' AND cache=1 ORDER BY listorder ASC,tid DESC");while($r = $db->fetch_array($result)) {$types[$r['tid']] = $r;}cache_write('type-'.$item.'.php', $types);return $types;} else {$arr = array();$result = $db->query("SELECT item FROM {$db->pre}type WHERE item!='' AND cache=1 ORDER BY tid DESC");while($r = $db->fetch_array($result)) {if(!in_array($r['item'], $arr)) {$arr[] = $r['item'];cache_type($r['item']);}}}}function cache_clear_ad($all = false) {global $XQ_TIME;$globs = glob(XQ_CACHE.'/ad/*.htm');if($globs) {foreach($globs as $v) {if(strpos($v, 'ad_', basename($v)) === false) continue;if($all) {file_del($v);} else {$exptime = intval(substr(file_get($v), 4, 14));if($exptime && $XQ_TIME > $exptime) file_del($v);}}}}?>
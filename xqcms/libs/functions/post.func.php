<?php defined('IN_XQCMS') or exit('Access Denied');function deditor($moduleid = 1, $textareaid = 'content', $toolbarset = 'Default', $width = 500, $height = 400) {global $XQ;$moddir = defined('XQ_ADMIN') ? XQ_PATH .'app/': '';$width = is_numeric($width) ? $width.'px' : $width;$height = is_numeric($height) ? $height.'px' : $width;$editor = '';$editor .= '<script type="text/javascript">var ModuleID = '.$moduleid.';';$editor .= 'var XQAdmin = '.(defined('XQ_ADMIN') ? 1 : 0).';';$editor .= 'var EDPath = "'.$moddir.'editor/";';$editor .= 'var EDW = "'.$width.'";';$editor .= 'var FCKID = "'.$textareaid.'";';$editor .= '</script>';$editor .= '<script type="text/javascript" src="'.$moddir.'editor/fckeditor.js"></script>';$editor .= '<script type="text/javascript">';$editor .= 'window.onload = function() {';$editor .= 'var sBasePath = "'.$moddir.'editor/";';$editor .= 'var oFCKeditor = new FCKeditor("'.$textareaid.'");';$editor .= 'oFCKeditor.Width = "'.$width.'";';$editor .= 'oFCKeditor.Height = "'.$height.'";';$editor .= 'oFCKeditor.BasePath = sBasePath;';$editor .= 'oFCKeditor.ToolbarSet = "'.$toolbarset.'";';$editor .= 'oFCKeditor.ReplaceTextarea();';$editor .= '}';$editor .= '</script>';echo $editor;}function color($name, $value = '') {global $xqcms_style_id;$style = $color = '';if(preg_match("/^#[0-9a-zA-Z]{6}$/", $value)) $color = $value;if(!$xqcms_style_id) {$xqcms_style_id = 1;$style .= '<script type="text/javascript" src="'.XQ_PATH.'data/js/color.js"></script>';} else {$xqcms_style_id++;}$style .= '<input type="hidden" name="'.$name.'" id="color_input_'.$xqcms_style_id.'" value="'.$color.'"/><img src="data/style/color.gif" width="21" height="18" align="absmiddle" id="color_img_'.$xqcms_style_id.'" style="cursor:pointer;background:'.$color.'" onclick="color_show('.$xqcms_style_id.', $(\'#color_input_'.$xqcms_style_id.'\').val(), this);"/>';return $style;}function dselect($sarray, $name, $title = '', $selected = 0, $extend = '', $key = 1, $ov = '', $abs = 0) {$select = '<select name="'.$name.'" '.$extend.'>';if($title) $select .= '<option value="'.$ov.'">'.$title.'</option>';foreach($sarray as $k=>$v) {if(!$v) continue;$_selected = ($abs ? ($key ? $k : $v) === $selected : ($key ? $k : $v) == $selected) ? ' selected=selected' : '';$select .= '<option value="'.($key ? $k : $v).'"'.$_selected.'>'.$v.'</option>';}$select .= '</select>';return $select;}function type_select($item, $cache = 0, $name = 'tid', $title = '', $tid = 0, $extend = '', $all = '') {$TYPE = get_type($item, $cache);$select = '<select name="'.$name.'" '.$extend.'>';if($all) $select .= '<option value="-1"'.($tid == -1 ? ' selected=selected' : '').'>'.$all.'</option>';if($title) $select .= '<option value="0"'.($tid == 0 ? ' selected=selected' : '').'>'.$title.'</option>';foreach($TYPE as $k=>$v) {$select .= ' <option value="'.$k.'"'.($k == $tid ? ' selected' : '').'> '.$v['name'].'</option>';}$select .= '</select>';return $select;}function tpl_select($file = 'index', $module = '', $name = 'template', $title = '', $template = '', $extend = '') {global $WEB, $xqcms_tpl_id;if(!$xqcms_tpl_id) {$xqcms_tpl_id = 1;} else {$xqcms_tpl_id++;}$tpldir = $module ? XQ_ROOT."/templates/".$WEB['templates']."/".$module : XQ_ROOT."/templates/".$WEB['templates'];@include $tpldir."/these.name.php";$select = '<span id="xqcms_template_'.$xqcms_tpl_id.'"><select name="'.$name.'" '.$extend.'><option value="">'.$title.'</option>';$files = glob($tpldir."/*.htm");foreach($files as $tplfile)	{$tplfile = basename($tplfile);$tpl = str_replace('.htm', '', $tplfile);if(preg_match("/^".$file."-(.*)/i", $tpl) || !$file) {$selected = ($template && $tpl == $template) ? 'selected' : '';$templatename = (isset($names[$tpl]) && $names[$tpl]) ? $names[$tpl] : $tpl;$select .= '<option value="'.$tpl.'" '.$selected.'>'.$templatename.'</option>';}}$select .= '</select></span>';return $select;}function category_select($name = 'catid', $title = '', $catid = 0, $moduleid = 1, $extend = '') {$option = cache_read('catetree-'.$moduleid.'.php', '', true);if($option) {if($catid) $option = str_replace('value="'.$catid.'"', 'value="'.$catid.'" selected', $option);$select = '<select name="'.$name.'" '.$extend.' id="catid_1">';if($title) $select .= '<option value="0">'.$title.'</option>';$select .= $option ? $option : '</select>';return $select;} else {return ajax_category_select($name, $title, $catid, $moduleid, $extend);}}function get_category_select($title = '', $catid = 0, $moduleid = 1, $extend = '', $deep = 0, $cat_id = 1) {global $CATEGORY, $DCAT;$CATBAK = $CATEGORY ? $CATEGORY : array();if(!$CATEGORY) {if(isset($DCAT[$moduleid])) {$CATEGORY = $DCAT[$moduleid];} else {$CATEGORY = $DCAT[$moduleid] = cache_read('category-'.$moduleid.'.php');}}$parents = array();$cid = $catid;if($catid && $CATEGORY[$catid]['child']) $parents[] = $catid;while($catid) {if($CATEGORY[$cid]['parentid']) {$parents[] = $cid = $CATEGORY[$cid]['parentid'];} else {break;}}$parents[] = 0;$parents = array_reverse($parents);$select = '';foreach($parents as $k=>$v) {if($deep && $deep <= $k) break;$select .= '<select onchange="category(this.value, '.$cat_id.');" '.$extend.'>';if($title) $select .= '<option value="0">'.$title.'</option>';foreach($CATEGORY as $c) {if($c['parentid'] == $v) {$selectid = isset($parents[$k+1]) ? $parents[$k+1] : $catid;$selected = $c['catid'] == $selectid ? ' selected' : '';$select .= '<option value="'.$c['catid'].'"'.$selected.'>'.$c['catname'].'</option>';}}$select .= '</select> ';}$CATEGORY = $CATBAK;return $select;}function ajax_category_select($name = 'catid', $title = '', $catid = 0, $moduleid = 1, $extend = '', $deep = 0) {global $cat_id;if($cat_id) {$cat_id++;} else {$cat_id = 1;}$catid = intval($catid);$deep = intval($deep);$select = '';$select .= '<input name="'.$name.'" id="catid_'.$cat_id.'" type="hidden" value="'.$catid.'"/>';$select .= '<span id="category_'.$cat_id.'">'.get_category_select($title, $catid, $moduleid, $extend, $deep, $cat_id).'</span>';$select .= '<script type="text/javascript">';if($cat_id == 1) $select .= 'var category_moduleid = new Array;';$select .= 'category_moduleid['.$cat_id.']="'.$moduleid.'";';if($cat_id == 1) $select .= 'var category_title = new Array;';$select .= 'category_title['.$cat_id.']=\''.$title.'\';';if($cat_id == 1) $select .= 'var category_extend = new Array;';$select .= 'category_extend['.$cat_id.']=\''.$extend.'\';';if($cat_id == 1) $select .= 'var category_catid = new Array;';$select .= 'category_catid['.$cat_id.']=\''.$catid.'\';';if($cat_id == 1) $select .= 'var category_deep = new Array;';$select .= 'category_deep['.$cat_id.']=\''.$deep.'\';';$select .= '</script>';if($cat_id == 1) $select .= '<script type="text/javascript" src="'.XQ_PATH.'data/js/category.js"></script>';return $select;}function posid_select_c($name, $posid = 0, $extend = '') {global $MOD, $L;$posid=explode(',', trim($posid));$names = isset($MOD['posid']) && $MOD['posid'] ? $MOD['posid'] : '';$names = $names ? explode(',', trim($names)) : array();$checkbox = '';for($i=0;$i<count($names);$i++){$box=explode("|",$names[$i]);$checked=in_array($box[1],$posid) ? 'checked' : '';$checkbox .= '<input name="'.$name.'[]" type="checkbox" value="'.$box[1].'" '.$checked.'/> '.$box[0];}if($extend) $checkbox .=$extend;return $checkbox;}function posid_select_s($posid = 0) {global $MOD;$posid=explode(',', trim($posid));$names = isset($MOD['posid']) && $MOD['posid'] ? $MOD['posid'] : '';$names = $names ? explode(',', trim($names)) : array();$checkbox = '';for($i=0;$i<count($names);$i++){$box=explode("|",$names[$i]);if(in_array($box[1],$posid)) $checkbox .='['.$box[0].']&nbsp;';}return $checkbox;}function posid_select($name, $title = '', $posid = 0, $extend = '') {global $MOD, $L;$names = isset($MOD['posid']) && $MOD['posid'] ? $MOD['posid'] : '';$names = $names ? explode(',', trim($names)) : array();$select = '<select name="'.$name.'" '.$extend.'>';if($title) $select .= '<option value="0">'.$title.'</option>';for($i=0;$i<count($names);$i++){$box=explode("|",$names[$i]);$select .= '<option value="'.$box[1].'"'.($box[1] == $posid ? ' selected' : '').'>'.$box[1].' '.$box[0].'</option>';}$select .= '</select>';return $select;}function is_gbk($string) {return preg_match("/^([\s\S]*?)([\x81-\xfe][\x40-\xfe])([\s\S]*?)/", $string);}function is_date($date, $sep = '-') {if(empty($date)) return false;if(strlen($date) > 10)return false;list($year, $month, $day) = explode($sep, $date);return checkdate($month, $day, $year);}function is_image($file) {return preg_match("/^(jpg|jpeg|gif|png|bmp)$/i", file_ext($file));}function is_md5($password) {return preg_match("/^[a-z0-9]{32}$/", $password);}function gb2py($text, $exp = '') {if(!$text) return '';if(strtolower(XQ_CHARSET) != 'gbk') $text = convert($text, XQ_CHARSET, 'gbk');$data = array();$tmp = @file(XQ_ROOT.'/data/table/gb-pinyin.table');if(!$tmp) return '';$tmps = count($tmp);for($i = 0; $i < $tmps; $i++) {$tmp1 = explode("	", $tmp[$i]);$data[$i]=array($tmp1[0], $tmp1[1]);}$r = array();$k = 0;$textlen = strlen($text);for($i = 0; $i < $textlen; $i++) {$p = ord(substr($text, $i, 1));if($p > 160) {$q = ord(substr($text, ++$i, 1));$p = $p*256+$q-65536;}if($p > 0 && $p < 160) {$r[$k] = chr($p);} elseif($p< -20319 || $p > -10247) {$r[$k] = '';} else {for($j = $tmps-1; $j >= 0; $j--) {if($data[$j][1]<=$p) break;}$r[$k] = $data[$j][0];}$k++;}return implode($exp, $r);}function match_userid($file) {$file = basename($file);if(preg_match("/\-([0-9]{2}+)\-([0-9]{1,}+)\./", $file, $m)) {return $m[2];} else {return 0;}}function clear_link($content) {$content = preg_replace("/<a[^>]*>/i", "", $content);return preg_replace("/<\/a>/i", "", $content);}function save_remote($content, $ext = 'jpg|jpeg|gif|png|bmp') {global $XQ, $XQ_TIME, $MODULE, $moduleid;if(!$content) return $content;if(!preg_match_all("/src=([\"|']?)([^ \"'>]+\.($ext))\\1/i", $content, $matches)) return $content;XQcms::load_xq_class('image');$dftp = false;$urls = $oldpath = $newpath = array();$XQ['uploaddir'] or $XQ['uploaddir'] = 'Ym/d';foreach($matches[2] as $k=>$url) {if(in_array($url, $urls)) continue;$urls[$url] = $url;if(strpos($url, '://') === false) continue;$filedir = 'upfiles/'.timetodate($XQ_TIME, $XQ['uploaddir']).'/';$filepath = XQ_PATH.$filedir;$fileroot = XQ_ROOT.'/'.$filedir;$file_ext = file_ext($url);$filename = date('YmdHis', $XQ_TIME).rand(10, 99).rand(10, 99).'.'.$file_ext;$newfile = $fileroot.$filename;if(file_copy($url, $newfile)) {if(is_image($newfile)) {if(!@getimagesize($newfile)) {file_del($newfile);continue;}if($XQ['water_type']) {$image = new image($newfile);if($XQ['water_type'] == 2) {$image->waterimage();} else if($XQ['water_type'] == 1) {$image->watertext();}}}$oldpath[] = $url;$newurl = linkurl($filepath.$filename, 1);if($dftp) {$exp = explode("upfiles/", $newurl);if($ftp->dftp_put($filedir.$filename, $exp[1])) {$newurl = $XQ['remote_url'].$exp[1];file_del($newfile);}}$newpath[] = $newurl;}}unset($matches);return str_replace($oldpath, $newpath, $content);}function save_thumb($content, $no, $width = 120, $height = 90) {global $XQ, $XQ_TIME;if(!$content) return '';$ext = 'jpg|jpeg|gif|png|bmp';if(!preg_match_all("/src=([\"|']?)([^ \"'>]+\.($ext))\\1/i", $content, $matches)) return '';require_once XQ_SYSROOT.'/libs/classes/image.class.php';$dftp = false;$urls = $oldpath = $newpath = array();$XQ['uploaddir'] or $XQ['uploaddir'] = 'Ym/d';foreach($matches[2] as $k=>$url) {if($k == $no - 1) {$filedir = 'upfiles/'.timetodate($XQ_TIME, $XQ['uploaddir']).'/';$filepath = XQ_PATH.$filedir;$fileroot = XQ_ROOT.'/'.$filedir;$file_ext = file_ext($url);$filename = date('YmdHis', $XQ_TIME).rand(10, 99).'.'.$file_ext;$newfile = $fileroot.$filename;if(file_copy($url, $newfile)) {if(is_image($newfile)) {if(!@getimagesize($newfile)) {file_del($newfile);return '';}$image = new image($newfile);$image->thumb($width, $height);}$newurl = linkurl($filepath.$filename, 1);if($dftp) {$exp = explode("upfiles/", $newurl);if($ftp->dftp_put($filedir.$filename, $exp[1])) {$newurl = $XQ['remote_url'].$exp[1];file_del($newfile);}}return $newurl;}}}unset($matches);return '';}function delete_upload($file, $userid) {global $WEB, $XQ, $XQ_TIME, $db;if(!defined('XQ_ADMIN') && (!$userid || $userid != match_userid($file))) return false;$fileurl = $file;$exp = explode("upfiles/", $file);$file = XQ_ROOT.'/upfiles/'.$exp[1];if(is_file($file)) {file_del($file);if(strpos($file, '.thumb.') !== false) {$ext = file_ext($file);file_del(str_replace('.thumb.'.$ext, '', $file));file_del(str_replace('.thumb.'.$ext, '.middle.'.$ext, $file));}}}?>
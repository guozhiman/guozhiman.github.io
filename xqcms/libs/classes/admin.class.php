<?php defined('IN_XQCMS') or exit('Access Denied');class admin {public $userid;public $username;private $founders;private $db;private $pre;public function admin() {global $db, $WEB;$this->founders = $WEB['founders'];$this->db = &$db;$this->pre = $this->db->pre;}private function is_user($username) {return $this->db->get_one("SELECT userid FROM {$this->pre}users WHERE username='$username'");}private function count_admin() {$r = $this->db->get_one("SELECT COUNT(*) AS num FROM {$this->pre}users WHERE groupid=1 AND admin=1 ");return $r['num'];}public function set_admin($username, $admin, $role) {$username = trim($username);$r = $this->is_user($username);if(!$r) msg('用户不存在');$userid = $r['userid'];$this->db->query("UPDATE {$this->pre}users SET groupid=1,admin=$admin,role='$role' WHERE userid='$userid' ");return true;}public function move_admin($username) {$r = $this->fone($username);if($r && $r['admin'] > 0) {if($r['userid'] == $this->founders) msg('创始人不可改变级别');if($r['admin'] == 1 && $this->count_admin() < 2) msg('系统最少需要保留一位超级管理员');$admin = $r['admin'] == 1 ? 2 : 1;$this->db->query("UPDATE {$this->pre}users SET admin=$admin WHERE username='$username' ");return true;} else {msg('管理员不存在');}}public function delete_admin($username) {$r = $this->fone($username);if($r) {if($r['userid'] == $this->founders) msg('创始人不可删除');if($r['admin'] == 1 && $this->count_admin() < 2) msg('系统最少需要保留一位超级管理员');$userid = $r['userid'];$this->db->query("DELETE FROM {$this->pre}users WHERE userid='$userid'");$this->db->query("DELETE FROM {$this->pre}power WHERE userid='$userid'");cache_delete('menu-'.$userid.'.php');cache_delete('right-'.$userid.'.php');return true;} else {msg('会员不存在');}}public function fone($user, $type = 1) {$fields = $type ? 'username' : 'userid';return $this->db->get_one("SELECT * FROM {$this->pre}users WHERE `$fields`='$user'");}public function flist($condition) {global $pages, $page, $pagesize, $offset, $pagesize, $WEB;$r = $this->db->get_one("SELECT COUNT(*) AS num FROM {$this->pre}users WHERE $condition");$pages = pages($r['num'], $page, $pagesize);$admins = array();$result = $this->db->query("SELECT * FROM {$this->pre}users WHERE $condition ORDER BY admin ASC LIMIT $offset,$pagesize");while($r = $this->db->fetch_array($result)) {$r['lasttime'] = timetodate($r['lasttime'], 5);$r['adminname'] = $r['admin'] == 1 ? ($WEB['founders'] == $r['userid'] ? '<span class="f_red">网站创始人</span>' : '<span class="f_blue">超级管理员</span>') : '普通管理员';$admins[] = $r;}return $admins;}public function get_right($userid) {global $MODULE;$rights = array();$result = $this->db->query("SELECT * FROM {$this->pre}power WHERE userid=$userid AND url='' ORDER BY moduleid DESC,file DESC,adminid DESC ");while($r = $this->db->fetch_array($result)) {@include XQ_ROOT.'/'.($r['moduleid'] == 1 ? 'admin' : 'module/'.$MODULE[$r['moduleid']]['module'].'/admin').'/config.inc.php';$r['name'] = isset($RT['file'][$r['file']]) ? '('.$RT['file'][$r['file']].')' : '';$r['module'] = '('.$MODULE[$r['moduleid']]['name'].')';$rights[] = $r;}return $rights;}public function get_menu($userid) {$menus = array();$result = $this->db->query("SELECT * FROM {$this->pre}power WHERE userid=$userid AND url!='' ORDER BY listorder ASC,adminid ASC ");while($r = $this->db->fetch_array($result)) {$menus[] = $r;}return $menus;}public function update($userid, $right, $admin) {if(isset($right[0])){$this->add($userid, $right[0], $admin);unset($right[0]);foreach($right as $k=>$v) {if(isset($v['delete'])) {$this->delete($k);unset($right[$k]);}}$this->edit($right);$this->cache_menu($userid);return true;}if (!isset($right)) $this->db->query("DELETE FROM {$this->pre}power WHERE userid=$userid AND url=''");$arr=array();foreach($right as $k=>$v) {if(isset($v['file'])){$_right = $this->get_right($userid);foreach($_right as $_v) {if(!isset($right[$_v['moduleid']])){$this->db->query("DELETE FROM {$this->pre}power WHERE userid=$userid AND url='' AND moduleid='".$_v['moduleid']."'");}elseif(!in_array($_v['file'],$v['file']) && $_v['moduleid'] == $k) {$this->db->query("DELETE FROM {$this->pre}power WHERE userid=$userid AND url='' AND file='".$_v['file']."'");}else{$this->db->query("DELETE FROM {$this->pre}power WHERE userid=$userid AND url='' AND moduleid=$k");}}foreach($v['file'] as $kf=>$vf) {unset($arr);$arr['moduleid'] = $k;$arr['file'] = $vf;if(isset($v[$vf]['action'])) $arr['action'] = implode('|', $v[$vf]['action']);if(isset($v['catid']) && $vf=='index') $arr['catid'] = implode('|', $v['catid']);$this->add($userid,$arr, $admin);}}else{$this->db->query("DELETE FROM {$this->pre}power WHERE userid=$userid AND url=''");}}if($admin == 1) $this->db->query("DELETE FROM {$this->pre}power WHERE userid=$userid AND url=''");$this->cache_right($userid);$this->cache_menu($userid);return true;}public function add($userid, $right, $admin) {if(isset($right['url'])) {if(!$right['title'] || !$right['url']) return false;$r = $this->db->get_one("SELECT * FROM {$this->pre}power WHERE userid=$userid AND url='".$right['url']."'");if($r) return false;if($admin == 2 && defined('MANAGE_ADMIN')) {$r = $this->url_right($right['url']);if($r) $this->add($userid, $r, $admin);}}else {$right['moduleid'] = intval($right['moduleid']);if(!$right['moduleid']) return false;$_right = $this->get_right($userid);foreach($_right as $v) {if($v['file'] == '' && $v['moduleid'] == $right['moduleid']) return false;}if($right['file']) {foreach($_right as $v) {if($v['file'] == $right['file'] && $v['moduleid'] == $right['moduleid']) {$right['userid'] = $userid;$this->edit1($userid,$right);return false;}}} else {unset($right['action'], $right['catid']);}}$right['userid'] = $userid;$sql1 = $sql2 = '';foreach($right as $k=>$v) {$sql1 .= ','.$k;$sql2 .= ",'$v'";}$sql1 = substr($sql1, 1);$sql2 = substr($sql2, 1);$this->db->query("INSERT INTO {$this->pre}power ($sql1) VALUES($sql2)");}private function edit1($userid, $right) {$sql = '';foreach($right as $k=>$v) {$sql .= ",$k='$v'";}$sql = substr($sql, 1);$this->db->query("UPDATE {$this->pre}power SET $sql WHERE userid='$userid' AND moduleid='".$right['moduleid']."' AND file ='".$right['file']."'");if(!isset($right['action'])) $this->db->query("UPDATE {$this->pre}power SET action='' WHERE userid='$userid' AND moduleid='".$right['moduleid']."' AND file ='".$right['file']."'");if(!isset($right['catid'])) $this->db->query("UPDATE {$this->pre}power SET catid='' WHERE userid='$userid' AND moduleid='".$right['moduleid']."' AND file ='".$right['file']."'");}private function edit($right, $type = 0) {if($type) {$moduleids = $adminids = array();foreach($right as $k=>$v) {if(!$v['file']) {$moduleids[] = $v['moduleid'];$adminids[$v['moduleid']] = $k;$right[$k]['action'] = $right[$k]['catid'] = '';}}if($moduleids) {foreach($right as $k=>$v) {if(in_array($v['moduleid'], $moduleids) && !in_array($k, $adminids)) {unset($right[$k]);$this->delete($k);}}}}foreach($right as $key=>$value) {if(isset($value['title'])) {if(!$value['title'] || !$value['url']) continue;} else {$value['moduleid'] = intval($value['moduleid']);if(!$value['moduleid']) continue;}$sql = '';foreach($value as $k=>$v) {$sql .= ",$k='$v'";}$sql = substr($sql, 1);$this->db->query("UPDATE {$this->pre}power SET $sql WHERE adminid='$key'");}}private function url_right($url) {if(substr($url, 0, 1) == '?') $url = substr($url, 1);$arr = array();parse_str($url);$arr['moduleid'] = isset($moduleid) ? $moduleid : 1;$arr['file'] = isset($file) ? $file : 'index';$arr['action'] = isset($action) ? $action : '';return $arr;}public function cache_right($userid) {$rights = $this->get_right($userid);$right = $moduleids = array();foreach($rights as $v) {isset($moduleids[$v['moduleid']]) or $moduleids[$v['moduleid']] = $v['moduleid'];}foreach($moduleids as $m) {foreach($rights as $r) {if($r['moduleid'] == $m) {$r['file'] = $r['file'] ? $r['file'] : 'NA';$right[$m][$r['file']]['action'] = $r['action'] ? explode('|', $r['action']) : '';$right[$m][$r['file']]['catid'] = $r['catid'] ? explode('|', $r['catid']) : '';}}}foreach($right as $k=>$v) {if(isset($v['NA'])) $right[$k] = '';}foreach($right as $k=>$v) {if($v) {foreach($v as $i=>$j) {if(!$j['action'] && !$j['catid']) $right[$k][$i] = '';}}}cache_write('right-'.$userid.'.php', $right);}public function cache_menu($userid) {$menus = $this->get_menu($userid);$menu = $r = array();foreach($menus as $k=>$v) {$r['title'] = $v['title'];$r['color'] = $v['color'];$r['url'] = $v['url'];$menu[] = $r;}cache_write('menu-'.$userid.'.php', $menu);}public function delete($adminid) {$this->db->query("DELETE FROM {$this->pre}power WHERE adminid=$adminid");}public function add_user($users) {global $XQ, $XQ_TIME, $XQ_IP;if($this->is_user($users['username'])) msg('用户名已经存在，请重先输入！');$users['password'] = md5(md5($users['password']));unset($users['cpassword']);$users_sqln = $users_sqlv = '';foreach($users as $n=>$v) {$users_sqln .= ','.$n; $users_sqlv .= ",'$v'";}$users_sqln = substr($users_sqln, 1);$users_sqlv = substr($users_sqlv, 1);$this->db->query("INSERT INTO {$this->pre}users ($users_sqln,addtime,lastip,lasttime)VALUES ($users_sqlv,'$XQ_TIME','$XQ_IP','$XQ_TIME')");return true;}public function login($login_username, $login_password, $admin = false) {global $XQ_TIME, $XQ_IP;$user =$this->db->get_one("SELECT * FROM {$this->pre}users WHERE username='$login_username'");if(!$user) msg('输入用户名错误！');if(!$admin) {if($user['password'] != (is_md5($login_password) ? md5($login_password) : md5(md5($login_password)))) {msg('输入密码不正确');}}set_cookie('userid', $user['userid']);$this->db->query("UPDATE {$this->pre}users SET lastip='$XQ_IP',lasttime=$XQ_TIME,logins=logins+1 WHERE username='$login_username'");return $user;}}?>
<?php defined('IN_XQCMS') or exit('Access Denied');class db_mysql {private $connid;private $querynum = 0;public $halt = 0;public $pre;private $result = array();public function connect($dbhost, $dbuser, $dbpw, $dbname, $dbcharset, $pconnect = 0) {$func = $pconnect == 1 ? 'mysql_pconnect' : 'mysql_connect';if(!$this->connid = @$func($dbhost, $dbuser, $dbpw)) $this->halt('MYSQL 连接数据库失败,请确定数据库用户名,密码设置正确<br>');if($this->version() > '4.1' && $dbcharset) mysql_query("SET NAMES '".$dbcharset."'" , $this->connid);if($this->version() > '5.0') mysql_query("SET sql_mode=''", $this->connid);if($dbname && !mysql_select_db($dbname, $this->connid)) $this->halt('当前使用的数据库 '.$dbname.'不存在');return $this->connid;}public function query($sql, $type = '') {$func = $type == 'UNBUFFERED' ? 'mysql_unbuffered_query' : 'mysql_query';if(!($query = $func($sql, $this->connid))) $this->halt('MySQL Query Error', $sql);$this->querynum++;return $query;}public function get_one($sql, $type = '') {$sql = str_replace(array('select ', ' limit '), array('SELECT ', ' LIMIT '), $sql);if(strpos($sql, 'SELECT ') !== false && strpos($sql, ' LIMIT ') === false) $sql .= ' LIMIT 0,1';$query = $this->query($sql, $type);$r = $this->fetch_array($query);$this->free_result($query);return $r ;}public function count($table, $condition = '') {global $XQ_TIME;$sql = 'SELECT COUNT(*) as amount FROM '.$table;if($condition) $sql .= ' WHERE '.$condition;$r = $this->get_one($sql);return $r ? $r['amount'] : 0;}public function fetch_array($query, $result_type = MYSQL_ASSOC) {return mysql_fetch_array($query, $result_type);}public function affected_rows() {return mysql_affected_rows($this->connid);}public function num_rows($query) {return mysql_num_rows($query);}public function num_fields($query) {return mysql_num_fields($query);}public function result($query, $row) {return @mysql_result($query, $row);}private function free_result($query) {return @mysql_free_result($query);}public function insert_id() {return mysql_insert_id($this->connid);}public function fetch_row($query) {return mysql_fetch_row($query);}public function version() {return mysql_get_server_info($this->connid);}public function close() {return mysql_close($this->connid);}public function error() {return @mysql_error($this->connid);}public function errno() {return intval(@mysql_errno($this->connid)) ;}private function halt($message = '', $sql = '')	{if(strpos($this->error(), 'crashed and should be repaired') !== false) {if(preg_match("/FROM(.*)WHERE/i", $sql, $m)) {$table = trim($m[1]);$this->query("REPAIR TABLE {$table}");dalert('', '', 'window.reload();');}}if($this->halt) message('MySQL Query:'.$sql.' <br/> MySQL Error:'.$this->error().' MySQL Errno:'.$this->errno().' <br/>Message:'.$message);}}?>
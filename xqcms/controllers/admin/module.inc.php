<?php defined('IN_XQCMS') or exit('Access Denied');$menus = array (array('添加模块', '?file='.$file.'&action=add'),array('模块管理', '?file='.$file),array('更新缓存', '?file='.$file.'&action=cache'),);$this_forward = '?file='.$file;$modid = isset($modid) ? intval($modid) : 0;function get_modules() {$mdirs = array('article','products','job','down','app');$sysmodules = array();foreach($mdirs as $v) {if(is_file(XQ_SYSROOT.'/controllers/'.$v.'/admin/setup/config.inc.php')) {include XQ_SYSROOT.'/controllers/'.$v.'/admin/setup/config.inc.php';$sysmodules[$SET['module']] = $SET;}}return $sysmodules;}switch($action) {case 'add':if($submit) {if(!$post['name']) msg('请填写模块名称');if(!$post['url']) msg('请填写链接地址');$post['url'] = $post['islink'] ? $post['url'] : linkurl($post['moduledir']."/");if($post['islink']) $post['module'] = 'xiqiao';$post['setuptime'] = $XQ_TIME;if($SET['moduleid']) {$db->query("DELETE FROM {$XQ_PRE}module WHERE moduleid=".$SET['moduleid']);$post['moduleid'] = $SET['moduleid'];}$sqln = $sqlv = $s = "";foreach($post as $key=>$value) {$sqln .= $s.$key;$sqlv .= $s."'".$value."'";$s = ",";}$db->query("INSERT INTO {$XQ_PRE}module ($sqln) VALUES ($sqlv)");$moduleid = $db->insert_id();$db->query("UPDATE {$XQ_PRE}module SET listorder=$moduleid WHERE moduleid=$moduleid");cache_module();dmsg('模块安装成功', $this_forward);} else {include tpl('module_add');}break;case 'edit':if(!$modid) msg('模块ID不能为空');$r = $db->get_one("SELECT * FROM {$XQ_PRE}module WHERE moduleid='$modid'");if(!$r) msg('模块不存在');extract($r);if($submit) {if(!$post['name']) msg('请填写模块名称');if($islink) {if(!$post['url']) msg('请填写链接地址');} else {if(!$post['moduledir']) msg('请填写安装目录');if(!preg_match("/^[0-9a-z_-]+$/i", $post['moduledir'])) msg('目录名不合法,请更换一个再试');$sysdirs = array('app', 'data', 'upfiles', 'xqcms', 'style', 'templates');if(in_array($post['moduledir'], $sysdirs)) msg('安装目录与系统目录冲突，请更换安装目录');$r = $db->get_one("SELECT moduleid FROM {$XQ_PRE}module WHERE moduledir='$post[moduledir]' AND moduleid!=$modid");if($r) msg('此目录名已经被其他模块使用,请更换一个再试');$post['url'] = linkurl($post['moduledir']."/");}$sql = $s = "";foreach($post as $key=>$value) {$sql .= $s.$key."='".$value."'";$s = ",";}$db->query("UPDATE {$XQ_PRE}module SET $sql WHERE moduleid=$modid");if(!$islink && $moduledir != $post['moduledir']) {rename(XQ_ROOT.'/'.$moduledir, XQ_ROOT.'/'.$post['moduledir']) or msg('无法重命名目录'.$moduledir.'为'.$post['moduledir'].',请手动修改');}cache_module();dmsg('模块修改成功', $this_forward);} else {@include XQ_SYSROOT.'/controllers/'.$module.'/admin/setup/config.inc.php';$modulename = isset($SET['name']) ? $SET['name'] : '';include tpl('module_edit');}break;case 'delete':if(!$modid) msg('模块ID不能为空');if($modid < 5) msg('系统模型不可删除');$r = $db->get_one("SELECT * FROM {$XQ_PRE}module WHERE moduleid='$modid'");if(!$r) msg('此模块不存在');if(!$r['islink']) msg('系统内置模块不能删除！');$db->query("DELETE FROM {$XQ_PRE}module WHERE moduleid='$modid'");cache_module();dmsg('模块删除成功', $this_forward);break;case 'disable':if(!$modid) msg('模块ID不能为空');if($modid < 5) msg('系统模型不可关闭');$value = $value ? 1 : 0;$db->query("UPDATE {$XQ_PRE}module SET disabled='$value' WHERE moduleid=$modid");cache_module();dmsg('模块状态已经修改', $this_forward);break;case 'order':foreach($listorder as $k=>$v) {$k = intval($k);$v = intval($v);$db->query("UPDATE {$XQ_PRE}module SET listorder='$v' WHERE moduleid=$k");}cache_module();dmsg('更新成功', $this_forward);break;case 'cache':cache_module();dmsg('更新成功', $this_forward);break;case 'ckdir':if(!preg_match("/^[0-9a-z_-]+$/i", $moduledir)) dialog('不是一个合法的目录名,请更换一个再试');$r = $db->get_one("SELECT moduleid FROM {$XQ_PRE}module WHERE moduledir='$moduledir'");if($r || is_dir(XQ_ROOT.'/'.$moduledir.'/')) dialog('该目录名已经被使用,请更换一个再试');dialog('目录名可以使用');break;default:$sysmodules = get_modules();$modules = $_modules = array();$result = $db->query("SELECT * FROM {$XQ_PRE}module WHERE moduleid>4 ORDER BY listorder ASC,moduleid DESC");while($r = $db->fetch_array($result)) {if($r['moduleid'] == 1) continue;$r['setuptime'] = timetodate($r['setuptime'], 3);$r['modulename'] = isset($sysmodules[$r['module']]) ? $sysmodules[$r['module']]['name'] : '外链';if($r['disabled']) {$_modules[] = $r;} else {$modules[] = $r;}}include tpl('module');break;}?>
<?php defined('IN_XQCMS') or exit('Access Denied');$mid = isset($mid) ? intval($mid) : 1;$CATEGORY = cache_read('category-'.$mid.'.php');$ITEMS = cache_read('cateitem-'.$mid.'.php');$mod = cache_read('module-'.$mid.'.php');$catid = isset($catid) ? intval($catid) : 0;XQcms::load_xq_class('category');$do = new category($mid, $catid);$parentid = isset($parentid) ? intval($parentid) : 0;$table = $XQ_PRE.'category';$menus = array (array('添加分类', '?file='.$file.'&action=add&mid='.$mid.'&parentid='.$parentid),array('管理分类', '?file='.$file.'&mid='.$mid),array('更新地址', '?file='.$file.'&action=url&mid='.$mid),array('更新统计', '?file='.$file.'&action=count&mid='.$mid),array('更新缓存', '?file='.$file.'&action=cache&mid='.$mid),);switch($action) {case 'add':if($submit) {if(!$category['catname']) msg('分类名不能为空');$category['catname'] = trim($category['catname']);$childs = '';$catids = array();$do->add($category);$childs .= ','.$do->catid;$catids[] = $do->catid;if($category['parentid']) {$parents = array();$cid = $category['parentid'];$parents[] = $cid;while(1) {if($CATEGORY[$cid]['parentid']) {$parents[] = $cid = $CATEGORY[$cid]['parentid'];} else {break;}}foreach($parents as $catid) {$arrchildid = $CATEGORY[$catid]['child'] ? $CATEGORY[$catid]['arrchildid'].$childs : $catid.$childs;$db->query("UPDATE {$table} SET child=1,arrchildid='$arrchildid' WHERE catid=$catid");}}foreach($catids as $catid) {$CATEGORY[$catid] = $db->get_one("SELECT * FROM {$table} WHERE catid=$catid");update_category($mid, $catid, $CATEGORY, $mod);}$do->cache();dmsg('添加成功', '?file='.$file.'&mid='.$mid.'&parentid='.$category['parentid']);} else {include tpl('category_add');}break;case 'edit':$catid or msg();if($submit) {if(!$category['catname']) msg('分类名不能为空');if($category['parentid'] == $catid) msg('上级分类不能与当前分类相同');$do->edit($category);update_category($mid, $catid, $CATEGORY, $mod);$do->cache();dmsg('修改成功', '?file='.$file.'&mid='.$mid.'&parentid='.$category['parentid']);} else {extract($db->get_one("SELECT * FROM {$table} WHERE catid=$catid"));include tpl('category_edit');}break;case 'count':XQcms::load_xq_func('module');$tb =get_table($mid);if(!isset($num)) {$num = 50;}if(!isset($fid)) {$r = $db->get_one("SELECT MIN(catid) AS fid FROM {$table} WHERE moduleid=$mid");$fid = $r['fid'] ? $r['fid'] : 0;}isset($sid) or $sid = $fid;if(!isset($tid)) {$r = $db->get_one("SELECT MAX(catid) AS tid FROM {$table} WHERE moduleid=$mid");$tid = $r['tid'] ? $r['tid'] : 0;}if($fid <= $tid) {$result = $db->query("SELECT catid FROM {$table} WHERE moduleid=$mid AND catid>=$fid ORDER BY catid LIMIT 0,$num");if($db->affected_rows($result)) {while($r = $db->fetch_array($result)) {$catid = $r['catid'];$condition = 'status=3';$condition .= $CATEGORY[$catid]['child'] ? " AND catid IN (".$CATEGORY[$catid]['arrchildid'].")" : " AND catid=$catid";$items = $db->count($tb, $condition);$db->query("UPDATE {$table} SET items=$items WHERE catid=$catid");}$catid += 1;} else {$catid = $fid + $num;}} else {cache_item($mid);$do->cache();dmsg('更新成功', "?mid=$mid&file=$file");}msg('ID从'.$fid.'至'.($catid-1).'更新成功', "?mid=$mid&file=$file&action=$action&sid=$sid&fid=$catid&tid=$tid&num=$num");break;case 'ckdir':if($do->get_catdir($catdir)) {dialog('目录名可以使用');} else {dialog('目录名不合法或者已经被使用');}break;case 'url':foreach($CATEGORY as $c) {update_category($mid, $c['catid'], $CATEGORY, $mod);}$do->cache();dmsg('更新成功', "?mid=$mid&file=$file");break;case 'cache':$do->repair();dmsg('更新成功', "?mid=$mid&file=$file");break;case 'delete':if($catid) $catids = $catid;$catids or msg();$do->delete($catids);$do->cache();dmsg('删除成功', $forward);break;case 'update':if(!$category || !is_array($category)) msg();$do->update($category);foreach($category as $catid=>$v) {$CATEGORY[$catid] = $db->get_one("SELECT * FROM {$table} WHERE catid=$catid");update_category($mid, $catid, $CATEGORY, $mod);}$do->cache();dmsg('更新成功', $forward);break;default:$CATEGORY or msg('暂无分类,请先添加','?file='.$file.'&mid='.$mid.'&action=add&parentid='.$parentid);$XQCAT = array();$total = 0;foreach($CATEGORY as $k=>$v) {if($v['parentid'] != $parentid) continue;$v['childs'] = substr_count($v['arrchildid'], ',');$v['items'] = $ITEMS[$v['catid']];$total += $v['items'];$XQCAT[$k] = $v;}include tpl('category');break;}?>
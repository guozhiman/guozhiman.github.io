<?php defined('IN_XQCMS') or exit('Access Denied');define('MANAGE_ADMIN', true);XQcms::load_xq_class('admin');$do = new admin;$menus = array (array('添加管理员', '?moduleid='.$moduleid.'&file='.$file.'&action=add'),array('管理员管理', '?moduleid='.$moduleid.'&file='.$file),array('权限分配', '?moduleid='.$moduleid.'&file='.$file.'&action=right&userid='.$_userid),);$this_forward = '?file='.$file;switch($action) {case 'add':if($submit) {$username=$do->add_user($users);if($do->set_admin($users['username'], $admin, $role)) {$r = $do->fone($users['username']);$userid = $r['userid'];if($admin == 2) {foreach($MODULE as $m) {if(isset($roles[$m['moduleid']])) {$right = array();$right['title'] = $m['name'].'管理';$right['url'] = '?moduleid='.$m['moduleid'];$do->add($userid, $right, $admin);}}$do->cache_right($userid);$do->cache_menu($userid);}msg('管理员添加成功，下一步请分配权限和管理面板', '?file='.$file.'&action=right&userid='.$userid);}msg();} else {isset($username) or $username = '';include tpl('admin_add');}break;case 'move':if($do->move_admin($username)) dmsg('操作成功', $this_forward);msg();break;case 'delete':if($username==$_username) msg('错误，不能删除自己！');if($do->delete_admin($username)) dmsg('删除成功', $this_forward);msg();break;case 'role':$userid or exit(0);$name or exit(0);$userid = intval($userid);$name = convert($name, 'UTF-8', XQ_CHARSET);$db->query("UPDATE {$db->pre}users SET role='$name' WHERE userid=$userid");exit(1);break;case 'right':if(!$userid) msg();$user = $do->fone($userid, 0);if($submit) {if($do->update($userid, $right, $user['admin'])) {dmsg('更新成功', '?file='.$file.'&action=right&userid='.$userid);}msg();} else {if($userid==$WEB['founders'] && $_userid!=$WEB['founders']) msg(lang('message->no_power'));$username = $user['username'];$drights = $do->get_right($userid);$dmenus = $do->get_menu($userid);include tpl('admin_right');}break;case 'password':if($submit) {if(!$password) msg('请输入新密码');if(strlen($password) < 6) msg('新密码最少6位，请修改');if($password != $cpassword) msg('两次输入的密码不一致，请检查');$password = md5(md5($password));$db->query("UPDATE {$db->pre}users SET password='$password',edittime=$XQ_TIME WHERE userid='$userid'");dmsg('管理员密码修改成功', '?file='.$file);} else {if($userid==$WEB['founders'] && $_userid!=$WEB['founders']) msg(lang('message->no_power'));include tpl('password');}break;default:$sfields = array('按条件', '用户名', '角色');$dfields = array('username', 'username', 'role');isset($fields) && isset($dfields[$fields]) or $fields = 0;$type = isset($type) ? intval($type) : 0;$fields_select = dselect($sfields, 'fields', '', $fields);$condition = 'groupid=1 AND admin>0';if(!$_founder) $condition .= " AND userid<>{$WEB['founders']}";if($kw) $condition .= " AND $dfields[$fields] LIKE '%$kw%'";if($type) $condition .= " AND admin=$type";$lists = $do->flist($condition);include tpl('admin');break;}?>
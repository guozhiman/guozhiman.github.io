<?php defined('IN_XQCMS') or exit('Access Denied');XQcms::load_xq_func('module');$table = get_table($mid);$r = $db->get_one("SELECT * FROM {$XQ_PRE}module WHERE moduleid='$mid'");if(!$r || $r['islink'] ||$mid<5) msg();$module = $r['module'];$CATEGORY = cache_read('category-'.$mid.'.php');$ITEMS = cache_read('cateitem-'.$mid.'.php');$MOD= cache_read('module-'.$mid.'.php');$moduleid=$mid;$menus = array (array('生成网页', '?mid='.$mid.'&file='.$file),array('一键生成', '?mid='.$mid.'&file='.$file.'&action=all'),);$all = (isset($all) && $all) ? 1 : 0;$one = (isset($one) && $one) ? 1 : 0;$p=0;$this_forward = '?mid='.$mid.'&file='.$file;switch($action) {case 'all':msg('', '?mid='.$mid.'&file='.$file.'&action=show&update=1&all=1&one='.$one);break;case 'list':if(!$MOD['list_html']) {$all ? msg($MOD['name'].'列表生成成功', '?mid='.$mid.'&file='.$file.'&action=show&all='.$all.'&one='.$one) : msg($MOD['name'].'列表生成成功', $this_forward);}if(isset($catids)) {$KEYS = array_keys($CATEGORY);$sid = 0;$fid = $catids;isset($tid) or $tid = count($KEYS);if(isset($KEYS[$catids])) {$bcatid = $catid = $KEYS[$catids];$total = max(ceil($ITEMS[$catid]/$MOD['pagesize']), 1);$num = 50;$bfid = $fid;isset($fpage) or $fpage = 1;if($fpage <= $total) {$fid = $fpage;tohtml('list', $module);$fid = $bfid;msg($MOD['name'].' ['.$CATEGORY[$bcatid]['catname'].'] 第'.$fpage.'页至第'.($fpage+$num-1).'页生成成功'.progress($sid, $fid, $tid,&$p), '?mid='.$mid.'&file='.$file.'&action='.$action.'&catids='.$catids.'&tid='.$tid.'&all='.$all.'&p='.$p.'&one='.$one.'&fpage='.($fpage+$num));}msg($MOD['name'].' ['.$CATEGORY[$bcatid]['catname'].'] 生成成功'.progress($sid,$fid+1, $tid,&$p), '?mid='.$mid.'&file='.$file.'&action='.$action.'&catids='.($catids+1).'&tid='.$tid.'&all='.$all.'&p='.$p.'&one='.$one);} else {$all ? msg($MOD['name'].'列表生成成功', '?mid='.$mid.'&file='.$file.'&action=show&all='.$all.'&one='.$one) : msg($MOD['name'].'列表生成成功', $this_forward);}} else {$indextotal=0;foreach($CATEGORY as $k=>$v){if(!$v['parentid']) $indextotal+=$ITEMS[$k];}$num = 50;isset($fid) or $fid = 1;$total = max(ceil($indextotal/$MOD['pagesize']), 1);if($fid <= $total) {tohtml('list', $module);$tid=($total<$num)?0:$total;msg($MOD['name'].'首页第'.$fid.'页至第'.($fid+$num-1).'页生成成功'.progress($sid, $fid, $tid,&$p), '?mid='.$mid.'&file='.$file.'&action='.$action.'&all='.$all.'&p='.$p.'&one='.$one.'&fid='.($fid+$num));} else {$catids = 0;msg('', '?mid='.$mid.'&file='.$file.'&action='.$action.'&catids='.$catids.'&all='.$all.'&one='.$one);}}break;case 'show':$update = (isset($update) && $update) ? 1 : 0;if(!$update && !$MOD['show_html']) {if($one) msg('', '?file=update&action=back&mid='.$mid);$all ? msg($MOD['name'].'生成成功', $this_forward) : dmsg($MOD['name'].'生成成功', $this_forward);}$catid = isset($catid) ? intval($catid) : '';$sql = $catid ? " AND catid=$catid" : '';$con = $module=='article' ? " AND islink=0" : '';if(!isset($fid)) {$r = $db->get_one("SELECT min(id) AS fid FROM {$table} WHERE status>2 {$con} {$sql}");$fid = $r['fid'] ? $r['fid'] : 0;}isset($sid) or $sid = $fid;if(!isset($tid)) {$r = $db->get_one("SELECT max(id) AS tid FROM {$table} WHERE status>2 {$con} {$sql}");$tid = $r['tid'] ? $r['tid'] : 0;}if($update) {XQcms::load_models($module);$do = new $module($mid);}isset($num) or $num = 100;if($fid <= $tid) {$result = $db->query("SELECT id FROM {$table} WHERE status>2 {$con} AND id>=$fid {$sql} ORDER BY id LIMIT 0,$num ");if($db->affected_rows($result)) {while($r = $db->fetch_array($result)) {$id = $r['id'];$update ? $do->update($id) : tohtml('show', $module);}$id += 1;} else {$id = $fid + $num;}} else {if($update) {$all ? msg('', '?mid='.$mid.'&file='.$file.'&action=list&all=1&one='.$one) : dmsg('更新成功', $this_forward);} else {if($one) msg($MOD['name'].'生成成功', '?file=update&action=back&mid='.$mid);$all ? msg($MOD['name'].'生成成功', $this_forward) : dmsg($MOD['name'].'生成成功', $this_forward);}}if($tid<$num) $tid=$fid;msg('ID从'.$fid.'至'.($id-1).$MOD['name'].($update ? '更新' : '生成').'成功'.progress($sid, $fid, $tid,&$p), "?mid=$mid&file=$file&action=$action&sid=$sid&fid=$id&tid=$tid&num=$num&update=$update&all=$all&one=$one&p=$p");break;case 'cate':$catid or msg('请选择分类');isset($num) or $num = 50;isset($fid) or $fid = 1;$total = max(ceil($ITEMS[$catid]/$MOD['pagesize']), 1);if($fpage && $tpage) {$fid = $fpage;$num = $tpage - $fpage + 1;tohtml('list', $module);dmsg('生成成功', $this_forward);}if($fid <= $total) {$tid=($total<$num)?0:$total;tohtml('list', $module);msg('第'.$fid.'页至第'.($fid+$num-1).'页生成成功'.progress($sid, $fid, $tid,&$p), '?mid='.$mid.'&file='.$file.'&action='.$action.'&catid='.$catid.'&fid='.($fid+$num).'&num='.$num.'&fpage='.$fpage.'&tpage='.$tpage.'&p='.$p);} else {dmsg('生成成功', $this_forward);}break;case 'item':$catid or msg('请选择分类');msg('', '?mid='.$mid.'&file='.$file.'&action=show&catid='.$catid.'&num='.$num.'&p='.$p);break;default:$r = $db->get_one("SELECT min(id) AS fid,max(id) AS tid FROM {$table} WHERE status=3");$fid = $r['fid'] ? $r['fid'] : 0;$tid = $r['tid'] ? $r['tid'] : 0;include tpl('html');break;}?>
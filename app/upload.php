<?php @set_time_limit(0);define('XQ_NONUSER', true);require '../global.php';$from = isset($from) ? trim($from) : '';get_cookie('userid') or exit(errmsg);in_array($from, array('thumb', 'album', 'editor', 'file','attach')) or exit('Access Denied');$_FILES or dalert(lang('message->upload_fail'));XQcms::load_xq_func('post');$uploaddir = 'upfiles/'.date($XQ['uploaddir'],$XQ_TIME).'/';is_dir(XQ_ROOT.'/'.$uploaddir) or dir_create(XQ_ROOT.'/'.$uploaddir);if($MG['uploadtype']) $XQ['uploadtype'] = $MG['uploadtype'];if($MG['uploadsize']) $XQ['uploadsize'] = $MG['uploadsize'];XQcms::load_xq_class('upload');$do = new upload($_FILES, $uploaddir);if($do->uploadfile()) {if(XQ_CHMOD) @chmod(XQ_ROOT.'/'.$do->saveto, XQ_CHMOD);$session = new dsession();if(in_array(strtolower($do->ext), array('jpg', 'jpeg', 'gif', 'png', 'swf', 'bmp')) && !@getimagesize(XQ_ROOT.'/'.$do->saveto)) {file_del(XQ_ROOT.'/'.$do->saveto);dalert(lang('message->upload_bad'));}$img_w = $img_h = 0;if($do->image) {XQcms::load_xq_class('image');if(strtolower($do->ext) == 'gif' && in_array($from, array('thumb', 'album'))) {if(!function_exists('imagegif') || !function_exists('imagecreatefromgif')) {file_del(XQ_ROOT.'/'.$do->saveto);dalert(lang('message->upload_jpg'));}}if($XQ['bmp_jpg'] && $do->ext == 'bmp') {XQcms::load_xq_func('bmp');$bmp_src = XQ_ROOT.'/'.$do->saveto;$bmp = imagecreatefrombmp($bmp_src);if($bmp) {$do->saveto = str_replace('.bmp', '.jpg', $do->saveto);$do->ext = 'jpg';imagejpeg($bmp, XQ_ROOT.'/'.$do->saveto);file_del($bmp_src);if(XQ_CHMOD) @chmod(XQ_ROOT.'/'.$do->saveto, XQ_CHMOD);}}$info = getimagesize(XQ_ROOT.'/'.$do->saveto);$img_w = $info[0];$img_h = $info[1];if($XQ['max_image'] && in_array($from, array('editor', 'album'))) {if($img_w > $XQ['max_image']) {$img_h = intval($XQ['max_image']*$img_h/$img_w);$img_w = $XQ['max_image'];$image = new image(XQ_ROOT.'/'.$do->saveto);$image->thumb($img_w, $img_h);}}if($from == 'thumb') {if($width && $height) {$image = new image(XQ_ROOT.'/'.$do->saveto);$image->thumb($width, $height, $XQ['thumb_title']);$img_w = $width;$img_h = $height;$do->file_size = filesize(XQ_ROOT.'/'.$do->saveto);}} else if($from == 'album') {$saveto = $do->saveto;$do->saveto = $do->saveto.'.thumb.'.$do->ext;file_copy(XQ_ROOT.'/'.$saveto, XQ_ROOT.'/'.$do->saveto);$middle = $saveto.'.middle.'.$do->ext;file_copy(XQ_ROOT.'/'.$saveto, XQ_ROOT.'/'.$middle);if($XQ['water_type'] == 2) {$image = new image(XQ_ROOT.'/'.$saveto);$image->waterimage();} else if($XQ['water_type'] == 1) {$image = new image(XQ_ROOT.'/'.$saveto);$image->watertext();}$image = new image(XQ_ROOT.'/'.$do->saveto);$image->thumb($width, $height, $XQ['thumb_album']);$image = new image(XQ_ROOT.'/'.$middle);$image->thumb($XQ['middle_w'], $XQ['middle_h'], $XQ['thumb_album']);if($XQ['water_middle'] && $XQ['water_type']) {if($XQ['water_type'] == 2) {$image = new image(XQ_ROOT.'/'.$middle);$image->waterimage();} else if($XQ['water_type'] == 1) {$image = new image(XQ_ROOT.'/'.$middle);$image->watertext();}}} else if($from == 'editor') {if(!isset($watermark)) $XQ['water_type'] = 0;if($XQ['water_type']) {$image = new image(XQ_ROOT.'/'.$do->saveto);if($XQ['water_type'] == 2) {$image->waterimage();} else if($XQ['water_type'] == 1) {$image->watertext();}}}}$saveto = linkurl($do->saveto, 1);$fid = isset($fid) ? $fid : '';$_SESSION['uploads'][] = $saveto;$js = '';$pr = 'parent.document.getElementById';if($from == 'thumb') {$js .= 'try{'.$pr.'("d'.$fid.'").src="'.$saveto.'";}catch(e){}';$js .= $pr.'("'.$fid.'").value="'.$saveto.'";';$js .= 'window.parent.cDialog();';} else if($from == 'album') {$js .= 'window.parent.getAlbum("'.$saveto.'", "'.$fid.'");';$js .= 'window.parent.cDialog();';} else if($from == 'editor') {$js .= 'window.parent.SetUrl("'.$saveto.'");';$js .= 'window.parent.GetE("frmUpload").reset();';} else if($from == 'attach') {$js .= 'window.parent.GetE("txtUrl").value="'.$saveto.'";';$js .= 'window.parent.GetE("frmUpload").reset();';} else if($from == 'file') {$js .= $pr.'("'.$fid.'").value="'.$saveto.'";';if($module == 'down') $js .= $pr.'("filesize").value="'.dround($do->file_size/1024/1024, 2).'";';$js .= 'window.parent.cDialog();';}dalert('', '', $js);} else {dalert($do->errmsg, '', '');}?>